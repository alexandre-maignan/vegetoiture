<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polygon Editing Intuitif</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }

    .leaflet-control-custom {
      background: #1976d2;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-family: sans-serif;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      user-select: none;
    }
    .leaflet-control-custom:hover { background: #125a9c; }

    .leaflet-interactive { stroke: #1976d2 !important; stroke-width: 3px; stroke-dasharray: 0 !important; }

    .leaflet-editing-icon, .leaflet-edit-move {
      background: #fff !important;
      border: 2px solid #1976d2 !important;
      border-radius: 50% !important;
      width: 12px !important;
      height: 12px !important;
      margin-left: -6px !important;
      margin-top: -6px !important;
    }

    .leaflet-editing-midpoint {
      background: #1976d2 !important;
      border-radius: 50% !important;
      width: 10px !important;
      height: 10px !important;
      margin-left: -5px !important;
      margin-top: -5px !important;
    }

    .leaflet-draw-guide-line,
    .leaflet-draw-guide-dash,
    path.leaflet-draw-preview {
      stroke-dasharray: 0 !important;
      stroke: #1976d2 !important;
      stroke-width: 2px !important;
    }
  </style>
</head>
<body>

<div id="map"></div>

<script>
const map = L.map("map").setView([48.8566, 2.3522], 13);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const drawnItems = new L.FeatureGroup().addTo(map);

/* BOUTON DESSINER */
const DrawButton = L.Control.extend({
  onAdd: function() {
    const btn = L.DomUtil.create("div", "leaflet-control-custom");
    btn.innerHTML = "✏️ Dessiner";
    btn.onclick = () => polygonDrawer.enable();
    return btn;
  }
});
map.addControl(new DrawButton({ position: "topleft" }));

/* OUTIL POLYGONE */
let polygonDrawer = new L.Draw.Polygon(map, {
  allowIntersection: false,
  showArea: false,
  shapeOptions: { color: "#1976d2", weight: 3 },
});

/* POLYGONE ACTIF */
let activePolygon = null;

map.on(L.Draw.Event.CREATED, function (e) {
  const layer = e.layer;
  drawnItems.addLayer(layer);

  // Désactiver l'ancien si existait
  if(activePolygon && activePolygon.editing.enabled()){
    activePolygon.editing.disable();
  }

  activePolygon = layer;
  layer.editing.enable();
});

/* CLIQUE SUR LA CARTE */
map.on("click", function(e){
  if(!activePolygon) return;

  // Si le clic est en dehors du polygone
  if(!activePolygon.getBounds().contains(e.latlng)){
    activePolygon.editing.disable();
    activePolygon = null;
  }
});

/* CLIQUE SUR POLYGONE → réactiver édition */
drawnItems.on('click', function(e){
  if(activePolygon && activePolygon.editing.enabled()) return; // déjà actif

  if(activePolygon && activePolygon.editing.enabled()) activePolygon.editing.disable();
  
  activePolygon = e.layer || e.target;
  activePolygon.editing.enable();
});
</script>

</body>
</html>

