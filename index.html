<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carte avec barre de boutons</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: 'Roboto', sans-serif; }
html, body { height:100%; width:100%; }
#mapContainer { position: relative; width: 100%; height: 100%; }
#map { width: 100%; height: 100%; }

/* Barre de boutons */
.mapbar {
    position: absolute;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 20px;
    z-index: 1000;
}
.footbar {
    position: absolute;
    bottom: 40px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    z-index: 1000;
}
.mapbar button, .footbar button {
    padding: 12px 15px;
    font-size: 16px;
    cursor: pointer;
    color: white;
    border: none;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    border-radius: 50px;
    background-color: #3399FF; /* bleu par défaut */
    display: flex;
    align-items: center;
    white-space: nowrap;
    transition: background-color 0.3s ease;
}
.mapbar button i, .footbar button i { margin-right: 8px; font-size: 1em; }
.mapbar button:hover, .footbar button:hover { filter: brightness(0.9); }

/* Style bouton annuler */
.mapbar button.cancel { background-color: #E53935; } /* rouge */

.mapbar .search-bar {
    display: flex;
    align-items: center;
    padding: 10px 14px;
    font-size: 16px;
    border-radius: 50px;
    border: none;
    background-color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}
.mapbar .search-bar i { margin-right: 8px; color: #555; cursor:pointer; }
.mapbar .search-bar input { border: none; outline: none; font-size: 14px; width: auto; }

/* Animation apparition bouton analyse */
#startAnalysisBtn { display: flex; opacity: 0; transform: translateY(20px); pointer-events: none; transition: opacity 0.4s ease, transform 0.4s ease; }
#startAnalysisBtn.show { opacity: 1; transform: translateY(0); pointer-events: auto; }

@media (max-width: 750px) {
    .mapbar { flex-direction: column; gap: 10px; top: 10px; }
    .mapbar button, .footbar button, .mapbar .search-bar { width: 70vw; justify-content: center; }
    .mapbar .search-bar input { width: 100%; }
}

/* Poignées rondes jaunes */
.leaflet-editing-icon {
    border-radius: 50% !important;
    background: white !important;
    border: 4px solid #FFD700 !important;
    width: 18px !important;
    height: 18px !important;
}
</style>
</head>
<body>

<div id="mapContainer">
    <div id="map"></div>
</div>

<div class="mapbar">
    <button id="btn1"><i class="fa-solid fa-pen"></i> Tracer la toiture</button>
    <div class="search-bar">
        <i id="searchBtn" class="fa-solid fa-magnifying-glass"></i>
        <input type="text" placeholder="Rechercher une adresse" id="searchInput">
    </div>
</div>

<div class="footbar">
    <button id="startAnalysisBtn"><i class="fa-solid fa-play"></i> Démarrer l'analyse</button>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
const map = L.map("map", {tap:true, zoomControl:true}).setView([48.8566, 2.3522], 16);
L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { maxZoom: 19 }).addTo(map);

map.zoomControl.remove();
L.control.zoom({ position: 'bottomright' }).addTo(map);
L.control.locate({ position: 'bottomright', flyTo: true, drawCircle: false }).addTo(map);

const drawnItems = new L.FeatureGroup().addTo(map);
const startBtn = document.getElementById("startAnalysisBtn");
const drawBtn = document.getElementById("btn1");
let isDrawing = false;

let polygonDrawer = new L.Draw.Polygon(map, {
    allowIntersection: false,
    shapeOptions: { color: "#FFD700", weight: 4, opacity: 1, fillOpacity: 0.2 }
});

// Cliquer sur le bouton
drawBtn.addEventListener("click", () => {
    if (!isDrawing) {
        // Commencer un nouveau tracé
        polygonDrawer.enable();
    } else {
        // Supprimer tous les polygones et réinitialiser le bouton
        drawnItems.clearLayers();
        drawBtn.innerHTML = '<i class="fa-solid fa-pen"></i> Tracer la toiture';
        drawBtn.classList.remove('cancel');
        isDrawing = false;
        startBtn.classList.remove("show");
    }
});

// Quand le dessin commence
map.on(L.Draw.Event.DRAWSTART, function () {
    isDrawing = true;
    drawBtn.innerHTML = '<i class="fa-solid fa-xmark"></i> Annuler le tracé';
    drawBtn.classList.add('cancel');
});

// Quand le polygone est créé
map.on(L.Draw.Event.CREATED, function (e) {
    const layer = e.layer;
    drawnItems.addLayer(layer);
    layer.editing.enable();
    startBtn.classList.add("show");

    // Le bouton reste rouge pour supprimer les polygones si on clique dessus
    isDrawing = true;
});

// Cliquer un polygone pour éditer
drawnItems.on('click', function(e){
    e.layer.editing.enable();
    startBtn.classList.add("show");
});

// Démarrer l'analyse
startBtn.addEventListener("click", function() { alert("Analyse démarrée !"); });

// Recherche
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
function geocodeAndMoveMap(query) {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
    fetch(url).then(r => r.json()).then(data => {
        if (data.length > 0) {
            const lat = parseFloat(data[0].lat);
            const lon = parseFloat(data[0].lon);
            map.setView([lat, lon], 16);
            L.marker([lat, lon]).addTo(map).bindPopup(query).openPopup();
        } else alert("Adresse introuvable");
    }).catch(() => alert("Erreur lors de la recherche"));
}
searchBtn.addEventListener('click', () => {
    const query = searchInput.value.trim();
    if (query) geocodeAndMoveMap(query);
});
searchInput.addEventListener('keypress', e => { if(e.key === 'Enter') searchBtn.click(); });
</script>
</body>
</html>

